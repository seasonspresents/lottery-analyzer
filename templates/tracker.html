<!DOCTYPE html>
<html data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Tracker | {{ state_cfg.abbreviation }} Scratcher</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap');
        :root {
            --pop-coral: #FF6B6B; --pop-green: #58CC02; --pop-yellow: #FFC800;
            --pop-purple: #A855F7; --pop-blue: #38BDF8; --pop-pink: #F472B6;
            --pop-orange: #FB923C; --pop-cream: #FFF8F0; --pop-mint: #6EE7B7;
        }
        body { font-family: 'Nunito', system-ui, sans-serif; background: var(--pop-cream); }
        .stat-card { transition: transform 0.15s ease; }
        .stat-card:hover { transform: translateY(-2px); }
        .session-row { transition: background 0.15s ease; }
        .session-row:hover { background: #FFF7ED !important; }
        .state-picker {
            font-family: 'Nunito', system-ui, sans-serif;
            font-weight: 800;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 10px;
            border: 2px solid #E5E7EB;
            background: white;
            color: #1a1a2e;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%239ca3af'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 26px;
        }
        .state-picker:focus { border-color: var(--pop-purple); outline: none; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <div class="bg-white border-b-4 border-[--pop-orange] shadow-sm">
        <div class="max-w-5xl mx-auto px-6 py-5 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div>
                    <h1 class="text-3xl font-black tracking-tight" style="color: #1a1a2e;">
                        <span style="color: var(--pop-orange);">Session</span> Tracker
                    </h1>
                    <p class="text-sm font-semibold mt-1" style="color: #9ca3af;">
                        Track every ticket. Know your real numbers.
                    </p>
                </div>
                <select class="state-picker" onchange="switchState(this.value)">
                    {% for code, cfg in states|dictsort %}
                    <option value="{{ code }}" {% if code == state %}selected{% endif %}>{{ cfg.abbreviation }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex gap-2">
                <a href="/?state={{ state }}" class="font-extrabold text-xs px-4 py-2 rounded-xl border-2 no-underline"
                   style="border-color: var(--pop-green); color: var(--pop-green);">Dashboard</a>
                <a href="/plan?state={{ state }}" class="font-extrabold text-xs px-4 py-2 rounded-xl border-2 no-underline"
                   style="border-color: var(--pop-purple); color: var(--pop-purple);">Game Plan</a>
                <a href="/stores?state={{ state }}" class="font-extrabold text-xs px-4 py-2 rounded-xl border-2 no-underline"
                   style="border-color: var(--pop-blue); color: var(--pop-blue);">Stores</a>
                <a href="/go" class="font-extrabold text-xs px-4 py-2 rounded-xl border-2 no-underline"
                   style="border-color: var(--pop-coral); color: var(--pop-coral);">ScratcherIQ</a>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-6 py-8">

        <!-- Lifetime Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card bg-white rounded-2xl p-5 shadow-sm text-center">
                <div class="text-xs font-bold text-gray-400">Total Spent</div>
                <div class="text-2xl font-black" id="statSpent" style="color: var(--pop-coral);">$0</div>
            </div>
            <div class="stat-card bg-white rounded-2xl p-5 shadow-sm text-center">
                <div class="text-xs font-bold text-gray-400">Total Won</div>
                <div class="text-2xl font-black" id="statWon" style="color: var(--pop-green);">$0</div>
            </div>
            <div class="stat-card bg-white rounded-2xl p-5 shadow-sm text-center">
                <div class="text-xs font-bold text-gray-400">Net P&L</div>
                <div class="text-2xl font-black" id="statNet" style="color: #1a1a2e;">$0</div>
            </div>
            <div class="stat-card bg-white rounded-2xl p-5 shadow-sm text-center">
                <div class="text-xs font-bold text-gray-400">Sessions</div>
                <div class="text-2xl font-black" id="statSessions" style="color: var(--pop-purple);">0</div>
            </div>
        </div>

        <!-- Spike's take -->
        <div id="spikeAdvice" class="bg-white rounded-2xl p-5 shadow-sm mb-8 flex items-start gap-3" style="display:none;">
            <div class="text-3xl flex-shrink-0">{{ state_cfg.mascot_emoji|safe }}</div>
            <div>
                <div class="text-sm font-black" style="color: var(--pop-green);">{{ state_cfg.mascot_name.split(' ')[0] }}'s Take</div>
                <div class="text-xs font-bold text-gray-500 mt-1" id="spikeAdviceText"></div>
            </div>
        </div>

        <!-- Log New Session -->
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mb-8">
            <h2 class="text-lg font-black mb-4" style="color: #1a1a2e;">Log a Session</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">Game</label>
                    <select id="sessionGame" class="select select-bordered w-full rounded-xl font-bold">
                        <option value="">Choose a game...</option>
                        {% for g in game_names %}
                        <option value="{{ g.name }}" data-price="{{ g.price }}">{{ g.name }} (${{ g.price|int }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">Date</label>
                    <input type="date" id="sessionDate" class="input input-bordered w-full rounded-xl font-bold">
                </div>
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">Tickets Bought</label>
                    <input type="number" id="sessionTickets" min="1" value="1" class="input input-bordered w-full rounded-xl font-bold">
                </div>
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">Total Spent ($)</label>
                    <input type="number" id="sessionSpent" min="0" step="1" class="input input-bordered w-full rounded-xl font-bold" placeholder="Auto-fills from game">
                </div>
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">Total Won ($)</label>
                    <input type="number" id="sessionWon" min="0" step="1" value="0" class="input input-bordered w-full rounded-xl font-bold">
                </div>
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">Second Chance Entered?</label>
                    <select id="sessionSecondChance" class="select select-bordered w-full rounded-xl font-bold">
                        <option value="no">Not yet</option>
                        <option value="yes">Yes, entered losers</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex gap-3">
                <button onclick="logSession()" class="font-extrabold text-white px-8 py-3 rounded-xl cursor-pointer border-0 active:scale-95"
                    style="background: var(--pop-green); box-shadow: 0 3px 10px rgba(88,204,2,0.3);">
                    Log Session
                </button>
            </div>
        </div>

        <!-- Session History -->
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-black" style="color: #1a1a2e;">Session History</h2>
            <button onclick="if(confirm('Clear all {{ state_cfg.abbreviation }} sessions?')){localStorage.removeItem(STORAGE_KEY);location.reload();}"
                class="text-xs font-bold px-3 py-1 rounded-lg cursor-pointer border-0" style="background:#FEE2E2;color:#991B1B;">
                Clear All
            </button>
        </div>
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <div id="historyEmpty" class="p-12 text-center" style="display:none;">
                <div class="text-4xl mb-3">{{ state_cfg.mascot_emoji|safe }}</div>
                <div class="text-sm font-bold text-gray-400">No sessions logged yet. Go play and come back to track it!</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="historyTable" style="display:none;">
                    <thead>
                        <tr class="border-b-2 border-gray-100">
                            <th class="px-4 py-3 text-left text-[10px] font-black uppercase text-gray-400">Date</th>
                            <th class="px-4 py-3 text-left text-[10px] font-black uppercase text-gray-400">Game</th>
                            <th class="px-4 py-3 text-right text-[10px] font-black uppercase text-gray-400">Tickets</th>
                            <th class="px-4 py-3 text-right text-[10px] font-black uppercase text-gray-400">Spent</th>
                            <th class="px-4 py-3 text-right text-[10px] font-black uppercase text-gray-400">Won</th>
                            <th class="px-4 py-3 text-right text-[10px] font-black uppercase text-gray-400">Net</th>
                            <th class="px-4 py-3 text-center text-[10px] font-black uppercase text-gray-400">2nd Chance</th>
                            <th class="px-4 py-3 text-center text-[10px] font-black uppercase text-gray-400"></th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Reinvestment Calculator -->
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mt-8">
            <div class="flex items-center gap-2 mb-4">
                <span class="text-2xl">{{ state_cfg.mascot_emoji|safe }}</span>
                <h2 class="text-lg font-black" style="color: #1a1a2e;">Reinvestment Calculator</h2>
            </div>
            <div class="text-xs font-bold text-gray-500 mb-4">
                Lustig's rule: reinvest 50% of winnings, pocket the other 50%. Never add money from your own pocket beyond your initial buy.
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">You Won ($)</label>
                    <input type="number" id="reinvestAmount" min="0" value="0" class="input input-bordered w-full rounded-xl font-bold">
                </div>
                <div>
                    <label class="text-xs font-black uppercase tracking-wider mb-1 block text-gray-400">Ticket Price ($)</label>
                    <input type="number" id="reinvestPrice" min="1" value="10" class="input input-bordered w-full rounded-xl font-bold">
                </div>
                <button onclick="calcReinvest()" class="font-extrabold text-white px-6 py-3 rounded-xl cursor-pointer border-0"
                    style="background: var(--pop-purple);">
                    Calculate
                </button>
            </div>
            <div id="reinvestResult" class="mt-4 p-4 rounded-2xl" style="background: #F0FDF4; display:none;">
                <div class="text-sm font-black" style="color: #065F46;" id="reinvestText"></div>
            </div>
        </div>
    </div>

    <script>
        const CURRENT_STATE = '{{ state }}';
        const STORAGE_KEY = CURRENT_STATE + '_sessions';

        function switchState(code) {
            window.location.href = '/tracker?state=' + code;
        }

        // Set today's date as default
        document.getElementById('sessionDate').valueAsDate = new Date();

        // Auto-fill spent when game or tickets change
        document.getElementById('sessionGame').addEventListener('change', autoFillSpent);
        document.getElementById('sessionTickets').addEventListener('input', autoFillSpent);

        function autoFillSpent() {
            const sel = document.getElementById('sessionGame');
            const opt = sel.options[sel.selectedIndex];
            const price = parseFloat(opt?.dataset?.price || 0);
            const tickets = parseInt(document.getElementById('sessionTickets').value) || 0;
            if (price > 0) document.getElementById('sessionSpent').value = price * tickets;
        }

        function getSessions() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
            catch { return []; }
        }

        function saveSessions(sessions) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
        }

        function logSession() {
            const game = document.getElementById('sessionGame').value;
            const date = document.getElementById('sessionDate').value;
            const tickets = parseInt(document.getElementById('sessionTickets').value) || 0;
            const spent = parseFloat(document.getElementById('sessionSpent').value) || 0;
            const won = parseFloat(document.getElementById('sessionWon').value) || 0;
            const secondChance = document.getElementById('sessionSecondChance').value;

            if (!game) { alert('Pick a game first!'); return; }
            if (!date) { alert('Set a date!'); return; }
            if (tickets < 1) { alert('Enter how many tickets you bought.'); return; }

            const sessions = getSessions();
            sessions.unshift({ id: Date.now(), game, date, tickets, spent, won, secondChance, net: won - spent });
            saveSessions(sessions);
            renderAll();

            // Reset form
            document.getElementById('sessionWon').value = '0';
            document.getElementById('sessionSecondChance').value = 'no';
        }

        function deleteSession(id) {
            const sessions = getSessions().filter(s => s.id !== id);
            saveSessions(sessions);
            renderAll();
        }

        function renderAll() {
            const sessions = getSessions();
            const tbody = document.getElementById('historyBody');
            const table = document.getElementById('historyTable');
            const empty = document.getElementById('historyEmpty');

            if (sessions.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
            } else {
                table.style.display = 'table';
                empty.style.display = 'none';
            }

            // Stats
            let totalSpent = 0, totalWon = 0;
            sessions.forEach(s => { totalSpent += s.spent; totalWon += s.won; });
            const net = totalWon - totalSpent;

            document.getElementById('statSpent').textContent = '$' + totalSpent.toLocaleString();
            document.getElementById('statWon').textContent = '$' + totalWon.toLocaleString();
            document.getElementById('statSessions').textContent = sessions.length;

            const netEl = document.getElementById('statNet');
            netEl.textContent = (net >= 0 ? '+$' : '-$') + Math.abs(net).toLocaleString();
            netEl.style.color = net >= 0 ? 'var(--pop-green)' : 'var(--pop-coral)';

            // Mascot's advice
            const adviceEl = document.getElementById('spikeAdvice');
            const adviceText = document.getElementById('spikeAdviceText');
            if (sessions.length >= 1) {
                adviceEl.style.display = 'flex';
                if (sessions.length < 3) {
                    adviceText.textContent = "You're just getting started. Keep logging every session — the more data I have, the better advice I can give you.";
                } else if (net >= 0) {
                    adviceText.textContent = "You're up $" + net.toLocaleString() + " across " + sessions.length + " sessions — nice! Pocket your profits. Remember: the #1 rule is never give back what you've won. Consider reducing your next buy or taking a break while you're ahead.";
                } else if (Math.abs(net) > totalSpent * 0.5) {
                    adviceText.textContent = "You're down $" + Math.abs(net).toLocaleString() + ". That's a rough streak. Lustig's rule: when you hit a cold streak, take a break. Skip a few days. The games aren't going anywhere — but your money is. Come back when the data shifts.";
                } else {
                    adviceText.textContent = "You're down $" + Math.abs(net).toLocaleString() + " across " + sessions.length + " sessions. That's expected — scratchers have negative expected value overall. Stick to the plan, don't increase your spend to chase losses, and make sure you're entering every loser in Second Chance drawings.";
                }
            } else {
                adviceEl.style.display = 'none';
            }

            // Table rows
            tbody.innerHTML = '';
            sessions.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'session-row border-b border-gray-50';
                const netColor = s.net >= 0 ? 'var(--pop-green)' : 'var(--pop-coral)';
                const netSign = s.net >= 0 ? '+' : '-';
                tr.innerHTML = `
                    <td class="px-4 py-3 font-bold text-gray-500">${s.date}</td>
                    <td class="px-4 py-3 font-extrabold" style="color:#1a1a2e;">${s.game}</td>
                    <td class="px-4 py-3 text-right font-bold" style="color:var(--pop-purple);">${s.tickets}</td>
                    <td class="px-4 py-3 text-right font-bold" style="color:var(--pop-coral);">$${s.spent}</td>
                    <td class="px-4 py-3 text-right font-bold" style="color:var(--pop-green);">$${s.won}</td>
                    <td class="px-4 py-3 text-right font-black" style="color:${netColor};">${netSign}$${Math.abs(s.net)}</td>
                    <td class="px-4 py-3 text-center">${s.secondChance === 'yes'
                        ? '<span class="text-[10px] font-black px-2 py-0.5 rounded-md" style="background:#D1FAE5;color:#065F46;">YES</span>'
                        : '<span class="text-[10px] font-black px-2 py-0.5 rounded-md" style="background:#FEE2E2;color:#991B1B;">NO</span>'}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteSession(${s.id})" class="text-[10px] font-bold text-gray-300 cursor-pointer border-0 bg-transparent hover:text-red-400">X</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calcReinvest() {
            const won = parseFloat(document.getElementById('reinvestAmount').value) || 0;
            const price = parseFloat(document.getElementById('reinvestPrice').value) || 1;
            const el = document.getElementById('reinvestResult');
            const txt = document.getElementById('reinvestText');

            if (won <= 0) { el.style.display = 'none'; return; }

            const pocket = Math.floor(won / 2);
            const reinvest = won - pocket;
            const tickets = Math.floor(reinvest / price);
            const leftover = reinvest - (tickets * price);

            el.style.display = 'block';
            txt.innerHTML = `
                <div>{{ state_cfg.mascot_emoji|safe }} <strong>Pocket:</strong> $${pocket} (this is YOUR money now, don't touch it)</div>
                <div class="mt-1"><strong>Reinvest:</strong> $${reinvest} → <strong>${tickets} tickets</strong> at $${price} each${leftover > 0 ? ` ($${leftover.toFixed(0)} leftover — pocket that too)` : ''}</div>
                <div class="mt-1 text-gray-400">Buy those ${tickets} tickets from the <strong>same roll, same game</strong>. If they all lose, STOP. Session over. You still walked away with $${pocket} profit.</div>
            `;
        }

        // Initial render
        renderAll();
    </script>
</body>
</html>
